pipeline {
    agent any

    environment {
        // Jenkins credential: Username with password
        DB_CREDENTIALS = credentials('db')
        DB_NAME = 'mydatabase'
        PYTHONPATH = "${WORKSPACE}"
        LOCAL_PARQUET_PATH = "C:/Users/Vladyslav_Buzan/Documents/parquet_data"
        JENKINS_PARQUET_PATH = "/root/parquet_data"
        REPORT_DIR = "reports"
        PROJECT_DIR = "PyTest DQ Framework"
    }

    stages {
        stage('Prepare System') {
            steps {
                sh '''
                    apt-get update
                    apt-get install -y libpq-dev python3 python3-pip python3-venv
                '''
            }
        }

        stage('Clone Repository') {
            steps {
                git branch: 'pytest_dq_framework', url: 'https://github.com/vlad89buzan/dqe-automation.git'
            }
        }

        stage('Set Up Environment') {
            steps {
                sh """
                    cd "${PROJECT_DIR}"
                    python3 -m venv venv
                    # Use bash to source venv properly
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                """
            }
        }

        stage('Debug Credentials') {
            steps {
                echo "DB Username from credentials: ${DB_CREDENTIALS_USR}"
            }
        }

        stage('Run Data Quality Tests') {
            steps {
                sh """
                    mkdir -p "${PROJECT_DIR}/${REPORT_DIR}"
                    parquet_path="${JENKINS_PARQUET_PATH:-${LOCAL_PARQUET_PATH}}"
                    echo "Using parquet path: $parquet_path"

                    cd "${PROJECT_DIR}"
                    . venv/bin/activate
                    export PYTHONPATH="\$WORKSPACE"

                    # Run pytest securely
                    pytest \\
                        --db_user "${DB_CREDENTIALS_USR}" \\
                        --db_password "${DB_CREDENTIALS_PSW}" \\
                        --html="${REPORT_DIR}/report_\\\$(date +%Y%m%d_%H%M%S).html" \\
                        --self-contained-html -v
                """
            }
        }
    }

    post {
        always {
            echo 'Pipeline execution completed.'
            archiveArtifacts artifacts: "${PROJECT_DIR}/${REPORT_DIR}/*.html", fingerprint: true
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed. Please check the HTML report in Jenkins artifacts.'
        }
    }
}
